# Cache requests for .*InRelease to reduce calls to apt-cacher-ng
location ~* ^.*InRelease$ {
  limit_req zone=acng burst=100;
  limit_req_log_level info;
  include proxy_params;
  proxy_pass http://127.0.0.1:3142;
  proxy_buffering on;
  proxy_pass_request_headers on;
  proxy_cache acng_cache;
  proxy_cache_key $scheme$proxy_host$request_uri;
  proxy_cache_valid any 1m;
  proxy_cache_lock on;
}

# Default location block
location / {
  limit_req zone=acng burst=100;
  limit_req_log_level info;
{% for ip in deb_apt_cache_allow_ips %}
  allow {{ ip }};
{% endfor %}
  deny all;
  include proxy_params;
  proxy_pass http://127.0.0.1:3142;
  proxy_buffering off;
  proxy_pass_request_headers on;
}
